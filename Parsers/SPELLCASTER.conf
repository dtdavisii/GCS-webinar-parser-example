#################################
# Google Cloud Security Webinar #
#     Example Parser: Part 1    #
#################################

## Written by: Darren Davis, Senior Strategic Solution Consultant
## Last Updated: December 10, 2025

filter {

  #pre-initialize udm fields
  mutate {
    replace => {
      "event.idm.read_only_udm.metadata.vendor_name" => "Cyber Darren"
      "event.idm.read_only_udm.metadata.product_name" => "Spell Caster Audit"
      "event.idm.read_only_udm.metadata.event_type" => "GENERIC_EVENT"
      "reason" = ""
    }
  }
  #extract json key:values and error if not present
  json {
    source => "message" #source is always message for the top-most log field
    array_function => "split_columns"
    on_error => "not_json"
  }
statedump {label => "pre_json_parsing"}
  #begin parsing if log is JSON
  if ![not_json] {

    # validate and assign date field
    # if this is not done, the parser will assume the ingest timestamp is the event timestamp.
    date {

      #you can have as many patterns and standards here as you'd like to validate against
      #the structure is "raw_log_keytoken" , "infinite" "formats"
      match => ["timestamp", "ISO8601"]
      
      #assign to UDM directly from the date function, default is @timestamp, which is used for metadata.event_timestamp.
      #target => "event.idm.read_only_udm.metadata.event_timestamp"
    }

    #check for login events
    if [event_type] != "" and [action] != "" {
      if [event_type] == "authentication" and [action] == "login" {
        #change the event type and set the description
        mutate {
          replace => {
            "event.idm.read_only_udm.metadata.event_type" => "USER_LOGIN"
          }
        }
      } else if [action] == "logout" {
        mutate {
          replace => {
            "event.idm.read_only_udm.metadata.event_type" => "USER_LOGOUT"
            }
        }
      }
      #set description UDM field
      mutate {
        replace => {
          "event.idm.read_only_udm.metadata.description" => "%{event_type}: %{action} %{result}"
        }
      }

      #USER_LOGIN/LOGOUT requires principal,target, intermediary, network, authentication, and security_result. Parse these things accordingly (does not have to be in order, but all must be present.)
      #set authentication field
      #note: =~ is to use regex in the comparison
      if [session][user_agent] =~ 'Linux|Windows|MacOS' {
        mutate {
          #merge example: create temporary var and append value to repeated field
          replace => {
            "_auth_mechanism" => "REMOTE"
          }
          merge => {
            "event.idm.read_only_udm.extensions.auth.mechanism" => "_auth_mechanism"
          }
        }
        mutate {
          replace => {
            "event.idm.read_only_udm.extensions.auth.type" => "MACHINE"
          }
        }
      }
      #set principal fields: user information
      if [user][username] != "" {
        mutate {
          replace => {
            "event.idm.read_only_udm.principal.user.userid" => "%{user.username}"
          }
        }
      } else {
        mutate {
          replace => {
            "event.idm.read_only_udm.principal.user.employee_id" => "%{user.user_id}"
          }
        }
      }
      #set principal fields: ip from session information
      if [session][ip_address] != "" {
        mutate {
          #merge example 1: merging directly into field
          merge => {
            "event.idm.read_only_udm.principal.ip" => "session.ip_address"
          }
        }
      }
      #set target fields
      if [app_details] != "" {
        mutate {
          replace => {
            "event.idm.read_only_udm.target.hostname" => "%{app_details.server}"
            "event.idm.read_only_udm.target.application" => "%{app_details.application}"
          }
        }
      }
      #set security result
      if [result] == "success" {
        mutate{
          replace => {
            "security_action" => "ALLOW"
          }
        }
        mutate {
          merge => {
            "security_result.action" => "security_action"
          }
        }
      } else {
        mutate{
          replace => {
            "security_action" => "BLOCK"
          }
        }
        mutate {
          merge => {
            "security_result.action" => "security_action"
          }
        }
      }
      mutate {
        merge => {
          "event.idm.read_only_udm.security_result" => "security_result"
        }
      }
    }
 }

#statedump{label => "Post output Merge"}
  mutate {
    merge => {
      "@output" => "event"
    }
  }
}